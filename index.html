<html>
<head>
    <script src="https://aframe.io/releases/0.7.0/aframe.min.js"></script>
    <script src="//cdn.rawgit.com/donmccurdy/aframe-extras/v3.13.1/dist/aframe-extras.min.js"></script>
    <script src="js/random.js"></script>
    <script>
        $ = (sel) => document.querySelector(sel)
        $$ = (sel) => document.querySelectorAll(sel)
        on = (elem, type, hand) => elem.addEventListener(type,hand)
    </script>


    <script>
        function rand(min,max) {
            return Math.random()*(max-min) + min
        }
        AFRAME.registerComponent('distribute', {
            schema: {
                src: {type:'string'},
                jitter: {type:'vec3'},
                centerOffset: {type:'vec3'},
                radius: {type:'number'}
            },
            init: function() {
                const rg = new Random(Random.engines.mt19937().seed(10))
                const center = new THREE.Vector3(this.data.centerOffset.x, this.data.centerOffset.y, this.data.centerOffset.z)
                const jx = this.data.jitter.x
                const jy = this.data.jitter.y
                const jz = this.data.jitter.z
                if($(this.data.src).hasLoaded) {
                    const s = this.data.radius
                    for(let i = -s; i<s; i++) {
                        for(let j=-s; j<s; j++) {
                            const el = document.createElement('a-entity')
                            el.setAttribute('gltf-model', this.data.src)
                            const offset = new THREE.Vector3(i*s + rg.real(-jx,jx), rg.real(-jy,jy), j*s - rg.real(-jz,jz));
                            el.setAttribute('position', center.clone().add(offset));
                            el.setAttribute('rotation',{x:0, y:rg.real(-45,45)*Math.PI/180, z:0})
                            const scale = rg.real(0.5,1.5)
                            el.setAttribute('scale',{x:scale,y:scale,z:scale})
                            $('a-scene').appendChild(el)
                        }
                    }
                }
            }
        })
    </script>
</head>
<body>



<a-scene
        stats
        physics="debug:false; restitution: 0; gravity:-4.0; contactEquationStiffness:100000000; contactEquationRelaxation: 0.5;"
        sound="src: url(./audio/octobernight2.mp3); loop:true; autoplay:true; volume:0.5;"
>
<!--         fog="type: linear; color: #3c1c71; far:40"
        fog="type:linear; color: #333333; near: 1; far: 300;"
-->
    <a-assets>
        <a-asset-item id="imp" src="models/imp/scene.gltf"></a-asset-item>
        <a-asset-item id="cauldron" src="models/cauldron/scene.gltf"></a-asset-item>
        <a-asset-item id="staff" src="models/staff/scene.gltf"></a-asset-item>
        <a-asset-item id="moon" src="models/moon/scene.gltf"></a-asset-item>
        <a-asset-item id="rock1" src="models/rock1/scene.gltf"></a-asset-item>
        <a-asset-item id="tree1" src="models/arbol1/scene.gltf"></a-asset-item>
        <a-asset-item id="tree2" src="models/arbol2/scene.gltf"></a-asset-item>
    </a-assets>


    <a-entity camera look-controls position="0 1.5 0">
        <a-cursor></a-cursor>
        <a-text id="score" value="Score" position="-0.2 -0.5 -1" color="red" width="5" anchor="left"></a-text>
        <!--<a-box id="weapon" position="0 2 -4" width="0.25" height="1" depth="1" color="blue" static-body="shape:box; mass:2"></a-box>-->

        <a-entity position="0 1 -3">
            <a-entity rotation="-90 0 0" position="0 -2 -1" id='weapon' static-body="shape:sphere; sphereRadius:0.3;">
                <a-entity position="2.3 -1.7 -16.3">
                    <a-entity gltf-model="#staff"></a-entity>
                </a-entity>
            </a-entity>
        </a-entity>
    </a-entity>

<!--                width="0.4" depth=0.25 height="0.25"
              material="color: red; emissive: red; emissiveIntensity: 0.2"

-->
    <a-entity id='box'
              position="0 0.1 -4"
              rotation="0 0 0"
              dynamic-body="shape:sphere; sphereRadius: 0.3; mass:4"
              shadow="cast:true;"
              sound="src: url(./audio/cowbell.mp3); autoplay: false; loop: false;"
    >
        <a-entity id='imp-model' gltf-model="#imp" position="0 -0.4 0" shadow="cast:true"></a-entity>
        <a-sphere id='regular-model' radius="0.25" segments-height="8" segments-width="8"
                  material="color: red; flatShading:true; emissive:red; emissiveIntensity:0.2"
                  shadow="cast:true"
        ></a-sphere>

    </a-entity>


    <a-plane position="0 0 -4" rotation="-90 0 0" width="100" height="100" color="#52430e" static-body
             shadow="receive:true"
    ></a-plane>


    <!-- cauldron from model, animated, with looping audio, positioned in front of the camera -->
    <a-entity  position="1.5 0 -3.5"
              gltf-model="#cauldron"
              animation-mixer shadow="cast:true"
              sound="src: url(./audio/boilingwater-loop.mp3); autoplay: true; loop:true;"></a-entity>

    <a-entity gltf-model="#moon"></a-entity>

    <a-entity gltf-model="#tree2" position="38 8.5 -10" shadow="cast:true"></a-entity>
    <a-entity gltf-model="#tree1" position="33 5.5 -10" shadow="cast:true"></a-entity>

    <a-entity gltf-model="#tree1" position="33 5.5 -30" shadow="cast:true" rotation="0 0 0"></a-entity>

    <!-- rocks -->
    <a-entity distribute="jitter: 2 0.5 2; centerOffset: 59 -0.8 32; src:#rock1; radius:3"></a-entity>

    <!-- background sky -->
    <a-sky color="#270d2c"></a-sky>


    <!--  shadowCameraVisible:true; -->
    <a-entity light="type: directional; color: #ffc18f; intensity: 0.5; castShadow: true; "
              position="31 80 -50"></a-entity>
    <a-entity light="type: hemisphere; color: white; groundColor: #5424ff; intensity: 0.4"></a-entity>
    <a-entity light="type: point; intensity: 1.6; distance: 5; decay: 2; color: red" position="0.275 -0.32 -3.77"></a-entity>
</a-scene>



<script>
    let score = 0;
    let hit = false
    let resetId = 0
    let count = 0;
    const resetBall = () => {
        console.log("reset")
        clearTimeout(resetId)
        count++

        let showImp = (count%2===0)

        $("#box").body.position.set(0, 0.6,-4)
        $("#box").body.velocity.set(0, 5,0)
        $("#box").body.angularVelocity.set(0, 0,0)
        $("#imp-model").setAttribute('visible',showImp);
        $("#regular-model").setAttribute('visible',!showImp);
        hit = false
        resetId = setTimeout(resetBall,6000)
    }
//    on($('#cursor'))

//    on(document,'click',(e)=>{
//        console.log("clicked")
//        const el = $("#box")
//        el.body.applyImpulse(
//            new CANNON.Vec3(0,10,0),
//            new CANNON.Vec3(0,0.1,0)
//        )
//    })

//    on(document,'mousemove',(e) => {
//        const weapon = $("#weapon");
////        weapon.body.position.set(
////            (e.clientX-document.body.clientWidth/2)/100,
////            (document.body.clientHeight/2-e.clientY)/100,
////            -4)
//        weapon.setAttribute('position',{
//            x:(e.clientX-document.body.clientWidth/2)/100,
//            y:(document.body.clientHeight/2-e.clientY)/100,z:-4})
//    })

    on($("#weapon"),'collide',(e)=>{
        const box = $("#box")
        if(e.detail.body.id === box.body.id && !hit) {
            hit = true
            box.components.sound.playSound();
            score = score + 1
            $("#score").setAttribute('text','value','Score '+score)
            clearTimeout(resetId)
            resetId = setTimeout(resetBall,2000)
        }
    })

    setTimeout(resetBall,3000)

</script>


<!--


cauldron https://sketchfab.com/models/e6eb5febb0ef4b63b3a90206a8b96135#download

imp: https://sketchfab.com/models/e4dd9c9d9ad14976a4ce0d1f6049292e

dragon staff: https://sketchfab.com/models/9d96aab0ddc34aae9f7bb5ae8dfc8bd6#download

moon: https://sketchfab.com/models/83c39af4bc5c478296501b80ef993855#download

rock 1: https://sketchfab.com/models/6a0fa67b84a44d51b929d8450fb1ec48#download




//turn off default lighting
//add ambient
add direcitonal down and up. need some nice shadows on the rocks. should we add real shadows? cauldron maybe?
//hemispeherical light?
//fire light around the cauldron
//make the moon glow
--add fog
make the staff glow
--imp and other object should glow
--how to make a gradient like skydome.


then add sounds
bubble sound: https://freesound.org/people/Euphrosyyn/sounds/370217/
cowbell: https://freesound.org/people/pj1s/sounds/34272/
crickets: https://freesound.org/people/sagetyrtle/sounds/62489/

used ffmpg to convert them. on mac
brew install ffmpeg
ffmpeg -i boilingwater-loop.wav boilingwater-loop.mp3


adjust random object generator to avoid the area around the camera
adjust score; cool font; new color


realistic !== immersive

add audio to scene to not have it be positional

-->
</body>
</html>